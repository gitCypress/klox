# klox é¡¹ç›®åˆ†æžæŠ¥å‘Š

## ðŸ“‹ é¡¹ç›®æ¦‚è§ˆ

**klox** æ˜¯ä¸€ä¸ªä½¿ç”¨ Kotlin å®žçŽ°çš„ Lox è¯­è¨€è§£é‡Šå™¨é¡¹ç›®ã€‚è¿™æ˜¯ã€ŠCrafting Interpretersã€‹ä¸€ä¹¦ä¸­ jloxï¼ˆJavaç‰ˆLoxï¼‰çš„ Kotlin ç§»æ¤ç‰ˆæœ¬ã€‚

### åŸºæœ¬ä¿¡æ¯
- **é¡¹ç›®åç§°**: klox
- **è¯­è¨€**: Kotlin 2.1.20
- **æž„å»ºå·¥å…·**: Maven
- **JVMç›®æ ‡**: 1.8
- **åŒ…å**: exp.compiler.klox

---

## ðŸ—ï¸ é¡¹ç›®æž¶æž„

### ç›®å½•ç»“æž„
```
src/main/kotlin/
â”œâ”€â”€ Lox.kt                    # ä¸»å…¥å£
â”œâ”€â”€ common/                   # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ LErr.kt              # é”™è¯¯å¤„ç†
â”‚   â””â”€â”€ extensions.kt        # æ‰©å±•å‡½æ•°
â”œâ”€â”€ fronted/                 # å‰ç«¯ç¼–è¯‘å™¨
â”‚   â”œâ”€â”€ Scanner.kt           # è¯æ³•åˆ†æžå™¨
â”‚   â””â”€â”€ Parser.kt            # è¯­æ³•åˆ†æžå™¨
â”œâ”€â”€ lang/                    # è¯­è¨€æ ¸å¿ƒå®šä¹‰
â”‚   â”œâ”€â”€ Token.kt             # Tokenæ•°æ®ç±»
â”‚   â”œâ”€â”€ TokenType.kt         # Tokenç±»åž‹æžšä¸¾
â”‚   â””â”€â”€ Expr.kt              # è¡¨è¾¾å¼ASTï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â””â”€â”€ tools/                   # å·¥å…·ç±»
    â”œâ”€â”€ GenerateAST.kt       # ASTä»£ç ç”Ÿæˆå™¨
    â””â”€â”€ AstUtils.kt          # ASTå·¥å…·å‡½æ•°
```

---

## ðŸ” æ ¸å¿ƒç»„ä»¶åˆ†æž

### 1. **ä¸»ç¨‹åº (Lox.kt:8-43)**
- **åŠŸèƒ½**: è§£é‡Šå™¨å…¥å£ç‚¹ï¼Œæ”¯æŒREPLå’Œæ–‡ä»¶æ‰§è¡Œä¸¤ç§æ¨¡å¼
- **æ‰§è¡Œæµç¨‹**:
  ```
  æºä»£ç  â†’ scanTokens() â†’ parse() â†’ toAST() â†’ è¾“å‡º
  ```
- **è®¾è®¡æ¨¡å¼**: ä½¿ç”¨Kotlinæ‰©å±•å‡½æ•°å®žçŽ°é“¾å¼è°ƒç”¨
- **çŠ¶æ€**: âœ… åŸºæœ¬å®Œæˆ

### 2. **è¯æ³•åˆ†æžå™¨ (Scanner.kt:7-202)**
- **èŒè´£**: å°†æºä»£ç å­—ç¬¦ä¸²è½¬æ¢ä¸ºTokenåˆ—è¡¨
- **ç‰¹æ€§**:
  - æ”¯æŒå•å­—ç¬¦å’ŒåŒå­—ç¬¦è¿ç®—ç¬¦è¯†åˆ«
  - å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆæ”¯æŒå¤šè¡Œï¼‰
  - æ•°å­—å­—é¢é‡ï¼ˆæ•´æ•°å’Œæµ®ç‚¹æ•°ï¼‰
  - æ ‡è¯†ç¬¦å’Œå…³é”®å­—è¯†åˆ«
  - æ³¨é‡Šå¤„ç†ï¼ˆ`//` å•è¡Œæ³¨é‡Šï¼‰
- **é”™è¯¯å¤„ç†**: é›†æˆLErrè¿›è¡Œé”™è¯¯æŠ¥å‘Š
- **çŠ¶æ€**: âœ… åŠŸèƒ½å®Œæ•´

**æ”¯æŒçš„å…³é”®å­—**:
```kotlin
and, class, else, false, for, fun, if, nil, or,
print, return, super, this, true, var, while
```

### 3. **è¯­æ³•åˆ†æžå™¨ (Parser.kt:8-165)**
- **èŒè´£**: å°†Tokenæµè½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘(AST)
- **è¯­æ³•è§„åˆ™** (é€’å½’ä¸‹é™è§£æžå™¨):
  ```
  expression â†’ equality
  equality   â†’ comparison ( ("!=" | "==") comparison )*
  comparison â†’ term ( (">" | ">=" | "<" | "<=") term )*
  term       â†’ factor ( ("+" | "-") factor )*
  factor     â†’ unary ( ("/" | "*") unary )*
  unary      â†’ ("!" | "-" | "+") unary | primary
  primary    â†’ NUMBER | STRING | "true" | "false" | "nil" | "(" expression ")"
  ```
- **è®¾è®¡äº®ç‚¹**:
  - ä½¿ç”¨ `parseLeftAssociative()` é«˜é˜¶å‡½æ•°å¤„ç†å·¦ç»“åˆè¿ç®—ç¬¦
  - å¼‚å¸¸é©±åŠ¨çš„é”™è¯¯å¤„ç†æœºåˆ¶
  - å®žçŽ°äº† `synchronize()` è¿›è¡Œé”™è¯¯æ¢å¤ï¼ˆè™½æœªè°ƒç”¨ï¼‰
- **çŠ¶æ€**: âš ï¸ ä»…æ”¯æŒè¡¨è¾¾å¼è§£æžï¼Œç¼ºå°‘è¯­å¥è§£æž

### 4. **ASTå®šä¹‰ (Expr.kt:5-13)**
```kotlin
sealed class Expr {
    Binary(left, operator, right)   // äºŒå…ƒè¿ç®—: 1 + 2
    Grouping(expression)            // åˆ†ç»„: (expr)
    Literal(value)                  // å­—é¢é‡: 123, "hello"
    Unary(operator, right)          // ä¸€å…ƒè¿ç®—: -1, !true
}
```
- **è®¾è®¡**: ä½¿ç”¨ sealed class + data class å®žçŽ°ç±»åž‹å®‰å…¨
- **ç”Ÿæˆæ–¹å¼**: é€šè¿‡ GenerateAST.kt è‡ªåŠ¨ç”Ÿæˆ
- **çŠ¶æ€**: âœ… è¡¨è¾¾å¼éƒ¨åˆ†å®Œæ•´

### 5. **é”™è¯¯å¤„ç† (LErr.kt:6-25)**
- **ç‰¹æ€§**:
  - å•ä¾‹æ¨¡å¼ (object)
  - å…¨å±€é”™è¯¯çŠ¶æ€è·Ÿè¸ª
  - æ”¯æŒæŒ‰è¡Œå·å’ŒTokenæŠ¥é”™
  - é”™è¯¯é‡ç½®åŠŸèƒ½ï¼ˆREPLéœ€è¦ï¼‰
- **è¾“å‡º**: æ ‡å‡†é”™è¯¯æµ (stderr)

### 6. **å·¥å…·ç±»**

#### AstUtils.kt:7-62
- `toAST()`: å°†è¡¨è¾¾å¼æ ‘è½¬æ¢ä¸ºS-è¡¨è¾¾å¼æ ¼å¼
- `toRPN()`: å°†è¡¨è¾¾å¼è½¬æ¢ä¸ºé€†æ³¢å…°è¡¨ç¤ºæ³•
- åŒ…å«æµ‹è¯•ç”¨ä¾‹æ ·ä¾‹

#### GenerateAST.kt:8-69
- ä»£ç ç”Ÿæˆå·¥å…·ï¼Œç”¨äºŽç”Ÿæˆ Expr.kt
- ä½¿ç”¨å­—ç¬¦ä¸²æ¨¡æ¿ç”Ÿæˆ Kotlin sealed class
- ç§»é™¤äº†Visitoræ¨¡å¼çš„å®žçŽ°

---

## ðŸ“Š å½“å‰å®žçŽ°è¿›åº¦

### âœ… å·²å®Œæˆ
1. **è¯æ³•åˆ†æž**: å®Œæ•´å®žçŽ°ï¼Œæ”¯æŒæ‰€æœ‰Lox token
2. **è¡¨è¾¾å¼è§£æž**: æ”¯æŒç®—æœ¯ã€æ¯”è¾ƒã€é€»è¾‘è¡¨è¾¾å¼
3. **ASTæž„å»º**: è¡¨è¾¾å¼æ ‘æž„å»ºå®Œæˆ
4. **åŸºç¡€æž¶æž„**: é”™è¯¯å¤„ç†ã€REPLã€æ–‡ä»¶æ‰§è¡Œ

### âš ï¸ è¿›è¡Œä¸­
- ä»Žgitæ—¥å¿—çœ‹ï¼Œåˆšå®Œæˆäº†ä»£ç é‡æž„ï¼ˆScannerå’ŒParserçš„Kotlinæ”¹é€ ï¼‰

### âŒ ç¼ºå¤±åŠŸèƒ½
1. **è¯­å¥è§£æž**: æ²¡æœ‰å®žçŽ° Statement AST
   - ç¼ºå°‘: printè¯­å¥ã€å˜é‡å£°æ˜Žã€å—è¯­å¥ã€if/while/forç­‰
2. **è¯­ä¹‰åˆ†æž**: æœªå®žçŽ°
3. **è§£é‡Šå™¨æ‰§è¡Œ**: æœªå®žçŽ° Visitor æˆ–æ±‚å€¼é€»è¾‘
4. **å˜é‡çŽ¯å¢ƒ**: æœªå®žçŽ°ä½œç”¨åŸŸå’Œå˜é‡ç»‘å®š
5. **å‡½æ•°è°ƒç”¨**: æœªå®žçŽ°å‡½æ•°å®šä¹‰å’Œè°ƒç”¨
6. **ç±»å’Œå¯¹è±¡**: æœªå®žçŽ°OOPç‰¹æ€§

---

## ðŸŽ¯ ä»£ç è´¨é‡è¯„ä¼°

### ä¼˜ç‚¹
1. **æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†**: frontend/lang/common åˆ†ç¦»åˆç†
2. **Kotlinæƒ¯ç”¨æ³•**: å……åˆ†åˆ©ç”¨æ‰©å±•å‡½æ•°ã€å¯†å°ç±»ã€åºåˆ—ç­‰ç‰¹æ€§
3. **å¯è¯»æ€§å¼º**: å‘½åæ¸…æ™°ï¼Œæ³¨é‡Šé€‚å½“ï¼ˆä¸­æ–‡æ³¨é‡Šï¼‰
4. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯æŠ¥å‘Šæœºåˆ¶
5. **ä»£ç ç”Ÿæˆ**: ä½¿ç”¨å…ƒç¼–ç¨‹å‡å°‘é‡å¤ä»£ç 

### æ”¹è¿›å»ºè®®
1. **å·²ä¿®å¤**: ~~Parser.kt:62 - unary() è°ƒç”¨äº† expression() è€Œéž unary()~~
2. **Parser.kt:146-162** - synchronize() æ–¹æ³•å·²å®žçŽ°ä½†æœªè¢«ä½¿ç”¨
3. **æµ‹è¯•**: ç¼ºå°‘å•å…ƒæµ‹è¯•
4. **æ–‡æ¡£**: ç¼ºå°‘READMEå’Œä½¿ç”¨è¯´æ˜Ž
5. **å¼‚å¸¸å¤„ç†**: ParseError åº”è¯¥æ›´è¯¦ç»†åœ°æºå¸¦ä¸Šä¸‹æ–‡ä¿¡æ¯

---

## ðŸš€ åŽç»­å¼€å‘å»ºè®®

### çŸ­æœŸç›®æ ‡
1. âœ… ~~ä¿®å¤ unary() çš„é€’å½’é—®é¢˜~~ (å·²å®Œæˆ)
2. å®žçŽ° Statement AST å’Œç›¸åº”çš„è§£æžå™¨æ–¹æ³•
3. å®žçŽ°è¡¨è¾¾å¼æ±‚å€¼å™¨ï¼ˆInterpreterï¼‰
4. æ·»åŠ åŸºæœ¬çš„æµ‹è¯•ç”¨ä¾‹

### ä¸­æœŸç›®æ ‡
1. å®žçŽ°å˜é‡å£°æ˜Žå’Œèµ‹å€¼
2. å®žçŽ°æŽ§åˆ¶æµè¯­å¥ (if/while/for)
3. å®žçŽ°å‡½æ•°å®šä¹‰å’Œè°ƒç”¨
4. æ·»åŠ æ ‡å‡†åº“å‡½æ•°

### é•¿æœŸç›®æ ‡
1. å®žçŽ°ç±»å’Œç»§æ‰¿
2. æ€§èƒ½ä¼˜åŒ–
3. æ·»åŠ è°ƒè¯•å™¨æ”¯æŒ
4. ç¼–å†™å®Œæ•´çš„æµ‹è¯•å¥—ä»¶

---

## ðŸ“ˆ æ€»ç»“

è¿™æ˜¯ä¸€ä¸ª**ç»“æž„è‰¯å¥½çš„ç¼–è¯‘å™¨å‰ç«¯å®žçŽ°**ï¼Œç›®å‰å¤„äºŽ**æ—©æœŸé˜¶æ®µ**ï¼ˆçº¦å®Œæˆ 20-25%ï¼‰ã€‚ä»£ç è´¨é‡é«˜ï¼Œéµå¾ªå‡½æ•°å¼ç¼–ç¨‹é£Žæ ¼ï¼Œå……åˆ†åˆ©ç”¨äº† Kotlin çš„è¯­è¨€ç‰¹æ€§ã€‚é¡¹ç›®æ­£æœç€å®Œæ•´å®žçŽ° Lox è¯­è¨€è§£é‡Šå™¨çš„ç›®æ ‡å‰è¿›ï¼Œä¸‹ä¸€æ­¥åº”ä¸“æ³¨äºŽå®Œæˆè¯­å¥è§£æžå’Œè§£é‡Šå™¨æ‰§è¡Œå¼•æ“Žã€‚

**æŠ€æœ¯æ ˆæˆç†Ÿåº¦**: é€‚åˆä½œä¸ºå­¦ä¹ ç¼–è¯‘å™¨åŽŸç†å’Œ Kotlin è¯­è¨€ç‰¹æ€§çš„æ•™å­¦é¡¹ç›®ã€‚

---

_æœ€åŽæ›´æ–°: 2025-10-15_